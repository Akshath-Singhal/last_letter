<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>last_letter: GPS.py Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">


</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">GPS.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="GPS_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespaceGPS.html">00001</a> <span class="comment">#!/usr/bin/env python</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="keyword">import</span> roslib
<a name="l00004"></a>00004 <span class="keyword">import</span> sys
<a name="l00005"></a>00005 <span class="keyword">import</span> rospy
<a name="l00006"></a>00006 <span class="keyword">import</span> ephem
<a name="l00007"></a>00007 <span class="keyword">from</span> urllib2 <span class="keyword">import</span> urlopen
<a name="l00008"></a>00008 <span class="keyword">import</span> datetime
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="keyword">from</span> geometry_msgs.msg <span class="keyword">import</span> Vector3, Vector3Stamped
<a name="l00012"></a>00012 <span class="keyword">import</span> numpy <span class="keyword">as</span> np
<a name="l00013"></a>00013 <span class="keyword">from</span> numpy.linalg <span class="keyword">import</span> inv, lstsq
<a name="l00014"></a>00014 <span class="keyword">from</span> uav_utils <span class="keyword">import</span> ECEF2lla, lla2ECEF
<a name="l00015"></a>00015 <span class="keyword">from</span> mathutils <span class="keyword">import</span> saturation, quat2Reb, Vector2Array, quat2euler, vectornorm, block_diag
<a name="l00016"></a>00016 <span class="keyword">from</span> math <span class="keyword">import</span> floor, exp, atan2, pi, sqrt, sin, cos
<a name="l00017"></a>00017 <span class="keyword">from</span> last_letter.msg <span class="keyword">import</span> SimStates, SimGPS, SimSats, Geoid
<a name="l00018"></a>00018 
<a name="l00019"></a><a class="code" href="namespaceGPS.html#a4bb9c1e78d696f248658787f1f818373">00019</a> _earth_E = sqrt(2.0*Geoid.EARTH_flattening - Geoid.EARTH_flattening*Geoid.EARTH_flattening)
<a name="l00020"></a>00020 
<a name="l00021"></a><a class="code" href="namespaceGPS.html#a749ca330fbf11df3e5ab0c18f83983a9">00021</a> lspeed=299792458.0              
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="comment">####################### subfunctions #############################################################</span>
<a name="l00024"></a><a class="code" href="namespaceGPS.html#ae32e4cb42a34a37ecb300682470293cf">00024</a> <span class="keyword">def </span><a class="code" href="namespaceGPS.html#ae32e4cb42a34a37ecb300682470293cf" title="subfunctions #############################################################">chunks</a>(l, n):
<a name="l00025"></a>00025         <span class="stringliteral">&quot;&quot;&quot; Yield successive n-sized chunks from l&quot;&quot;&quot;</span>
<a name="l00026"></a>00026         <span class="keywordflow">for</span> i <span class="keywordflow">in</span> xrange(0, len(l), n):
<a name="l00027"></a>00027                 <span class="keywordflow">yield</span> l[i:i+n]
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="comment">#######################  Magnetometer Class  #####################################################</span>
<a name="l00030"></a>00030 
<a name="l00031"></a><a class="code" href="classGPS_1_1GPSsensor.html">00031</a> <span class="keyword">class </span><a class="code" href="classGPS_1_1GPSsensor.html" title="Magnetometer Class #####################################################.">GPSsensor</a>():
<a name="l00032"></a><a class="code" href="classGPS_1_1GPSsensor.html#a4d249aeb0143f35c7a94691a42d09d5e">00032</a>         <span class="keyword">def </span><a class="code" href="classGPS_1_1GPSsensor.html#a4a9e77de3cc6b91311e18f2383b0a773">__init__</a>(self,name):
<a name="l00033"></a>00033                 
<a name="l00034"></a>00034                 rospy.loginfo(<span class="stringliteral">&#39;Create &#39;</span> + name +<span class="stringliteral">&#39; Sensor&#39;</span>)
<a name="l00035"></a>00035                 
<a name="l00036"></a>00036                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a62844f22233258e32084b8df78cc9414">maxdt</a> = 1.0/rospy.get_param(name+<span class="stringliteral">&#39;/maxrate&#39;</span>, 100.0)
<a name="l00037"></a>00037                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a8c1edf516ddc1cb5a8d2b55e7541a39b">maxrate</a> =  rospy.Rate(rospy.get_param(name+<span class="stringliteral">&#39;/maxrate&#39;</span>, 100.0))
<a name="l00038"></a>00038                 rospy.loginfo(<span class="stringliteral">&quot;\ta.maxrate: %.1f Hz&quot;</span>,1.0/self.<a class="code" href="classGPS_1_1GPSsensor.html#a62844f22233258e32084b8df78cc9414">maxdt</a>)
<a name="l00039"></a>00039 
<a name="l00040"></a>00040                 self.<a class="code" href="classGPS_1_1GPSsensor.html#ad68944d1e7004cf2787faf8ca7935249">dt</a> = 1.0/rospy.get_param(name+<span class="stringliteral">&#39;/rate&#39;</span>, 100.0)
<a name="l00041"></a>00041                 self.<a class="code" href="classGPS_1_1GPSsensor.html#ac05b8784dc7d4d6baa0333040cf3fdb1">rate</a> =  rospy.Rate(rospy.get_param(name+<span class="stringliteral">&#39;/rate&#39;</span>, 100.0))
<a name="l00042"></a>00042                 rospy.loginfo(<span class="stringliteral">&quot;\tb.rate: %.1f Hz&quot;</span>,1.0/self.<a class="code" href="classGPS_1_1GPSsensor.html#ad68944d1e7004cf2787faf8ca7935249">dt</a>)
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 
<a name="l00045"></a>00045                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a6d4af3716f52636aa65a1accb9567be4">cp</a> =  np.array(rospy.get_param(name+<span class="stringliteral">&#39;/CP&#39;</span>, [0.0, 0.0, 0.0])).reshape(3,1)
<a name="l00046"></a>00046                 rospy.loginfo(<span class="stringliteral">&quot;\tc.position: [%.2f,%.2f,%.2f]&quot;</span>, self.<a class="code" href="classGPS_1_1GPSsensor.html#a6d4af3716f52636aa65a1accb9567be4">cp</a>[0],self.<a class="code" href="classGPS_1_1GPSsensor.html#a6d4af3716f52636aa65a1accb9567be4">cp</a>[1],self.<a class="code" href="classGPS_1_1GPSsensor.html#a6d4af3716f52636aa65a1accb9567be4">cp</a>[2])
<a name="l00047"></a>00047 
<a name="l00048"></a>00048                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a> =  np.array(rospy.get_param(name+<span class="stringliteral">&#39;/resolution&#39;</span>, [3e-9, 1e-2, 1e-1, 1e-1, 1e-1])).reshape(5,1)<span class="comment"># np.array([3e-9, 1e-2, 1e-1, 1e-1, 1e-1]).reshape(5,1)</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a38c457ccafe3f73bc1e6d394c6c17025">cbias</a> =  rospy.get_param(name+<span class="stringliteral">&#39;/clock_bias&#39;</span>, 1.2)
<a name="l00051"></a>00051                 rospy.loginfo(<span class="stringliteral">&quot;\td.clock bias: %.2f sec&quot;</span>,self.<a class="code" href="classGPS_1_1GPSsensor.html#a38c457ccafe3f73bc1e6d394c6c17025">cbias</a>)
<a name="l00052"></a>00052 
<a name="l00053"></a>00053                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a11acf874da609db8fb6142cb428db425">std_coeff</a> = rospy.get_param(name+<span class="stringliteral">&#39;/std_coeff&#39;</span>, 10.0)
<a name="l00054"></a>00054                 rospy.loginfo(<span class="stringliteral">&quot;\te.noise coeff: %.1f meters &quot;</span>,self.<a class="code" href="classGPS_1_1GPSsensor.html#a11acf874da609db8fb6142cb428db425">std_coeff</a>)
<a name="l00055"></a>00055                 
<a name="l00056"></a>00056                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a> = SimGPS()
<a name="l00057"></a>00057 
<a name="l00058"></a>00058                 self.sat_sbas, self.<a class="code" href="classGPS_1_1GPSsensor.html#a48d3b88d9055a98bd6abbef75d959f4e">sat_gpsop</a> =  self.<a class="code" href="classGPS_1_1GPSsensor.html#a0d7de5b8df396e2b2180b980a17c9127">get_satellites</a>()
<a name="l00059"></a>00059 
<a name="l00060"></a>00060                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a64744faffe4fce980fbdbed2205e4276">pub</a> = rospy.Publisher(name, SimGPS)
<a name="l00061"></a>00061                 self.<a class="code" href="classGPS_1_1GPSsensor.html#aafa38e3ec5cf934fc871ddc9f7162d75">states_sub</a> = rospy.Subscriber(<span class="stringliteral">&quot;states&quot;</span>,SimStates,self.<a class="code" href="classGPS_1_1GPSsensor.html#a0308af7c2a2b3ca417090ce23ae90853">StatesCallback</a>)
<a name="l00062"></a>00062 
<a name="l00063"></a>00063                 self.<a class="code" href="classGPS_1_1GPSsensor.html#aafeca97af6dcdb1d2165883856bb7c4f">real</a>=SimStates()
<a name="l00064"></a>00064                 self.<a class="code" href="classGPS_1_1GPSsensor.html#ab76439a80d520b146ae80ff5c11bacbf">realnew</a>=<span class="keyword">False</span>
<a name="l00065"></a>00065                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a67bfe73d53aad63bb83638993ca589d3">place</a> = ephem.Observer()
<a name="l00066"></a>00066                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>=SimSats()
<a name="l00067"></a>00067                 
<a name="l00068"></a>00068                 self.<a class="code" href="classGPS_1_1GPSsensor.html#ac54ce2f6f4e3ced3ed7be7ffccabd9d2">firstime</a>=<span class="keyword">True</span>
<a name="l00069"></a>00069                 self.<a class="code" href="classGPS_1_1GPSsensor.html#ab56fa5e908d023ed0086a77363371ab8">position</a>=Vector3(6.378e6,0,0)
<a name="l00070"></a>00070                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a0b9a8cf72706e87d26037580450e8783">ctime</a> = 0.0
<a name="l00071"></a>00071 
<a name="l00072"></a>00072                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a439f61d70f1f6557f1b44c2954d515e7">maxcount</a> = int(self.<a class="code" href="classGPS_1_1GPSsensor.html#ad68944d1e7004cf2787faf8ca7935249">dt</a>/self.<a class="code" href="classGPS_1_1GPSsensor.html#a62844f22233258e32084b8df78cc9414">maxdt</a>)
<a name="l00073"></a>00073                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a89e92c5ef448dea50c13eae9735244a0">av</a>=[]
<a name="l00074"></a>00074                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a4d249aeb0143f35c7a94691a42d09d5e">xyzold</a>=[0, 0, 0]
<a name="l00075"></a>00075 
<a name="l00076"></a>00076                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a> = np.zeros((8,))
<a name="l00077"></a>00077                 self.<a class="code" href="classGPS_1_1GPSsensor.html#ae656549db04a1292c0cab57b550b2ddc">KP</a> = 10.0*np.eye(8)
<a name="l00078"></a>00078 
<a name="l00079"></a>00079                 Sf = 36.0
<a name="l00080"></a>00080                 Sg = 0.1
<a name="l00081"></a>00081                 sigma=5.0
<a name="l00082"></a>00082                 T3 = pow(self.<a class="code" href="classGPS_1_1GPSsensor.html#ad68944d1e7004cf2787faf8ca7935249">dt</a>,3)/3.0
<a name="l00083"></a>00083                 T2 = pow(self.<a class="code" href="classGPS_1_1GPSsensor.html#ad68944d1e7004cf2787faf8ca7935249">dt</a>,2)/2.0
<a name="l00084"></a>00084                 self.<a class="code" href="classGPS_1_1GPSsensor.html#af26a4026fc5a1bb274131604b11c43fa">KR</a> = 36.0;
<a name="l00085"></a>00085 
<a name="l00086"></a>00086                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a7547877bc18aa04b73c4ce118dae9825">speedold</a>=[0,0,0]
<a name="l00087"></a>00087                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a6696d86281702cdf71c63a20cd26d466">speed3</a>=Vector3()
<a name="l00088"></a>00088 
<a name="l00089"></a>00089                 Qxyz = sigma*sigma*np.array([T3, T2, T2, self.<a class="code" href="classGPS_1_1GPSsensor.html#ad68944d1e7004cf2787faf8ca7935249">dt</a>]).reshape(2,2)
<a name="l00090"></a>00090                 
<a name="l00091"></a>00091                 Qb = np.array([Sf*self.<a class="code" href="classGPS_1_1GPSsensor.html#ad68944d1e7004cf2787faf8ca7935249">dt</a>+Sg*T3, Sg*T2, Sg*T2, Sg*self.<a class="code" href="classGPS_1_1GPSsensor.html#ad68944d1e7004cf2787faf8ca7935249">dt</a>]).reshape(2,2)
<a name="l00092"></a>00092                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a0a773e0ce7bc9647301cf9b917d6507c">KQ</a> =  block_diag(Qxyz,Qxyz,Qxyz,Qb)
<a name="l00093"></a>00093 
<a name="l00094"></a>00094                 Jacobx = np.array([1.0,self.<a class="code" href="classGPS_1_1GPSsensor.html#ad68944d1e7004cf2787faf8ca7935249">dt</a>,0.0,1.0]).reshape(2,2)
<a name="l00095"></a>00095                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a2126a098243eee84d353ff31f8bcd745">Jx</a> =  block_diag(Jacobx,Jacobx,Jacobx,Jacobx)
<a name="l00096"></a>00096                 
<a name="l00097"></a><a class="code" href="classGPS_1_1GPSsensor.html#a0d7de5b8df396e2b2180b980a17c9127">00097</a>         <span class="keyword">def </span><a class="code" href="classGPS_1_1GPSsensor.html#a0d7de5b8df396e2b2180b980a17c9127">get_satellites</a>(self):
<a name="l00098"></a>00098                 <span class="comment">#GLONASS=&#39;http://celestrak.com/NORAD/elements/glo-ops.txt&#39;</span>
<a name="l00099"></a>00099                 SBAS = <span class="stringliteral">&#39;http://celestrak.com/NORAD/elements/sbas.txt&#39;</span>
<a name="l00100"></a>00100                 GPSO = <span class="stringliteral">&#39;http://www.celestrak.com/NORAD/elements/gps-ops.txt&#39;</span>
<a name="l00101"></a>00101     
<a name="l00102"></a>00102                 <span class="comment">#rospy.loginfo(&quot;[GPS] Get Glonass Sat. data&quot;) </span>
<a name="l00103"></a>00103                 <span class="comment">#r = urlopen(GLONASS).read()</span>
<a name="l00104"></a>00104                 <span class="comment">#data = r.split(&#39;\r\n&#39;)</span>
<a name="l00105"></a>00105 
<a name="l00106"></a>00106                 <span class="comment">#sat_glonass = []</span>
<a name="l00107"></a>00107                 <span class="comment">#for tle in chunks(data, 3):</span>
<a name="l00108"></a>00108                 <span class="comment">#       if len(tle)==3:</span>
<a name="l00109"></a>00109                 <span class="comment">#               sat_glonass.append(ephem.readtle(str(tle[0]), str(tle[1]), str(tle[2])))</span>
<a name="l00110"></a>00110 
<a name="l00111"></a>00111                 rospy.loginfo(<span class="stringliteral">&quot;[GPS] Get SBAS Sat. data&quot;</span>) 
<a name="l00112"></a>00112                 r = urlopen(SBAS).read()
<a name="l00113"></a>00113                 data = r.split(<span class="stringliteral">&#39;\r\n&#39;</span>)
<a name="l00114"></a>00114 
<a name="l00115"></a>00115                 sat_sbas=[]
<a name="l00116"></a>00116                 <span class="keywordflow">for</span> tle <span class="keywordflow">in</span> <a class="code" href="namespaceGPS.html#ae32e4cb42a34a37ecb300682470293cf" title="subfunctions #############################################################">chunks</a>(data, 3):
<a name="l00117"></a>00117                         <span class="keywordflow">if</span> len(tle)==3:
<a name="l00118"></a>00118                                 a=str(tle[0])
<a name="l00119"></a>00119                                 <span class="keywordflow">if</span> a.find(<span class="stringliteral">&#39;EGNOS&#39;</span>)&gt;0:
<a name="l00120"></a>00120                                         sat_sbas.append(ephem.readtle(str(tle[0]), str(tle[1]), str(tle[2])))
<a name="l00121"></a>00121                 rospy.loginfo(<span class="stringliteral">&quot;[GPS] Get GPS Operational Sat. data&quot;</span>)
<a name="l00122"></a>00122                 r = urlopen(GPSO).read()
<a name="l00123"></a>00123                 data = r.split(<span class="stringliteral">&#39;\r\n&#39;</span>)
<a name="l00124"></a>00124 
<a name="l00125"></a>00125                 sat_gosop=[]
<a name="l00126"></a>00126                 <span class="keywordflow">for</span> tle <span class="keywordflow">in</span> <a class="code" href="namespaceGPS.html#ae32e4cb42a34a37ecb300682470293cf" title="subfunctions #############################################################">chunks</a>(data, 3):
<a name="l00127"></a>00127                         <span class="keywordflow">if</span> len(tle)==3:
<a name="l00128"></a>00128                                 sat_gosop.append(ephem.readtle(str(tle[0]), str(tle[1]), str(tle[2])))
<a name="l00129"></a>00129                 
<a name="l00130"></a>00130                 <span class="keywordflow">return</span> sat_sbas,sat_gosop
<a name="l00131"></a>00131 
<a name="l00132"></a><a class="code" href="classGPS_1_1GPSsensor.html#a967cc0e49b69c168d656bff9baf2264c">00132</a>         <span class="keyword">def </span><a class="code" href="classGPS_1_1GPSsensor.html#a967cc0e49b69c168d656bff9baf2264c">getVisible</a>(self,pos,sat):
<a name="l00133"></a>00133                 <span class="keywordflow">for</span> iss <span class="keywordflow">in</span> sat:
<a name="l00134"></a>00134                         iss.compute(self.<a class="code" href="classGPS_1_1GPSsensor.html#a67bfe73d53aad63bb83638993ca589d3">place</a>)
<a name="l00135"></a>00135                         bad=abs(np.random.normal(0,3000,1))
<a name="l00136"></a>00136                         <span class="keywordflow">if</span> float(repr(iss.alt)) &gt; 15.0*pi/180.0 <span class="keywordflow">and</span> float(repr(iss.alt))&lt;pi/2.0 <span class="keywordflow">and</span> <span class="keywordflow">not</span> bad&gt;=9900:
<a name="l00137"></a>00137                                 possat=lla2ECEF(iss.sublat,iss.sublong,iss.elevation,Geoid.EARTH_radius,_earth_E)
<a name="l00138"></a>00138                                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible].position.x = possat.x
<a name="l00139"></a>00139                                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible].position.y = possat.y
<a name="l00140"></a>00140                                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible].position.z = possat.z
<a name="l00141"></a>00141                                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible].range=vectornorm(possat,pos)
<a name="l00142"></a>00142                                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible=self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible+1           
<a name="l00143"></a>00143                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.satellites=self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible
<a name="l00144"></a>00144 
<a name="l00145"></a><a class="code" href="classGPS_1_1GPSsensor.html#ad473e31618d88c61f8774fe3c99b53d0">00145</a>         <span class="keyword">def </span><a class="code" href="classGPS_1_1GPSsensor.html#ad473e31618d88c61f8774fe3c99b53d0">getdop</a>(self,pos):
<a name="l00146"></a>00146                 dop=[]
<a name="l00147"></a>00147                 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(0,self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible):
<a name="l00148"></a>00148                         dop.append((pos.x-self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[i].position.x)/self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[i].range)
<a name="l00149"></a>00149                         dop.append((pos.y-self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[i].position.y)/self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[i].range)
<a name="l00150"></a>00150                         dop.append((pos.z-self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[i].position.z)/self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[i].range)
<a name="l00151"></a>00151                         dop.append(1.0)
<a name="l00152"></a>00152 
<a name="l00153"></a>00153                 dop=-np.array(dop).reshape(self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible,4)
<a name="l00154"></a>00154                 G= inv(np.dot(dop.T,dop))
<a name="l00155"></a>00155                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.g = sqrt(np.trace(G))
<a name="l00156"></a>00156                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.p = sqrt(np.trace(G[0:3,0:3]))
<a name="l00157"></a>00157                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.h = sqrt(np.trace(G[0:2,0:2]))
<a name="l00158"></a>00158                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.v = sqrt(G[2,2])
<a name="l00159"></a>00159                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.t = sqrt(G[3,3])
<a name="l00160"></a>00160 
<a name="l00161"></a><a class="code" href="classGPS_1_1GPSsensor.html#a976db5cef756a2815c8549193bd4cf3b">00161</a>         <span class="keyword">def </span><a class="code" href="classGPS_1_1GPSsensor.html#a976db5cef756a2815c8549193bd4cf3b">setNoise</a>(self):
<a name="l00162"></a>00162                 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(0,self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible):
<a name="l00163"></a>00163                         self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[i].range = self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[i].range + self.<a class="code" href="classGPS_1_1GPSsensor.html#a38c457ccafe3f73bc1e6d394c6c17025">cbias</a>*lspeed + np.random.normal(0,self.<a class="code" href="classGPS_1_1GPSsensor.html#a11acf874da609db8fb6142cb428db425">std_coeff</a>,1)
<a name="l00164"></a>00164 
<a name="l00165"></a><a class="code" href="classGPS_1_1GPSsensor.html#a4a94041e216ee9b04e79e319cc3e4ccc">00165</a>         <span class="keyword">def </span><a class="code" href="classGPS_1_1GPSsensor.html#a4a94041e216ee9b04e79e319cc3e4ccc">getPosition</a>(self,k):
<a name="l00166"></a>00166                 cosine_vector=Vector3()
<a name="l00167"></a>00167                 G = np.zeros((self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible,4))
<a name="l00168"></a>00168                 dr = np.zeros((self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible,))
<a name="l00169"></a>00169                 Rc = 0.01<span class="comment">#*np.eye(self.sats.visible)</span>
<a name="l00170"></a>00170                 <span class="keywordflow">if</span> self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible&gt;3.0:
<a name="l00171"></a>00171                         <span class="keywordflow">if</span> self.<a class="code" href="classGPS_1_1GPSsensor.html#ac54ce2f6f4e3ced3ed7be7ffccabd9d2">firstime</a>:
<a name="l00172"></a>00172                                 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(0,10):
<a name="l00173"></a>00173                                         <span class="keywordflow">for</span> x <span class="keywordflow">in</span> range(0,self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible):
<a name="l00174"></a>00174                                                 cosine_vector.x=self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[x].position.x-self.<a class="code" href="classGPS_1_1GPSsensor.html#ab56fa5e908d023ed0086a77363371ab8">position</a>.x
<a name="l00175"></a>00175                                                 cosine_vector.y=self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[x].position.y-self.<a class="code" href="classGPS_1_1GPSsensor.html#ab56fa5e908d023ed0086a77363371ab8">position</a>.y
<a name="l00176"></a>00176                                                 cosine_vector.z=self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[x].position.z-self.<a class="code" href="classGPS_1_1GPSsensor.html#ab56fa5e908d023ed0086a77363371ab8">position</a>.z
<a name="l00177"></a>00177                                                 r_ref = sqrt(cosine_vector.x*cosine_vector.x+cosine_vector.y*cosine_vector.y+cosine_vector.z*cosine_vector.z)
<a name="l00178"></a>00178                                                 G[x,0] = -cosine_vector.x/r_ref
<a name="l00179"></a>00179                                                 G[x,1] = -cosine_vector.y/r_ref
<a name="l00180"></a>00180                                                 G[x,2] = -cosine_vector.z/r_ref
<a name="l00181"></a>00181                                                 G[x,3] = 1.0
<a name="l00182"></a>00182                                                 dr[x] = self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[x].range - r_ref -self.<a class="code" href="classGPS_1_1GPSsensor.html#a0b9a8cf72706e87d26037580450e8783">ctime</a>
<a name="l00183"></a>00183                                 
<a name="l00184"></a>00184                                         <span class="comment">#N=np.dot(G.T,Rc)</span>
<a name="l00185"></a>00185                                         <span class="comment">#c=np.dot(N,dr)</span>
<a name="l00186"></a>00186                                         <span class="comment">#N=np.dot(N,G)</span>
<a name="l00187"></a>00187                                                 
<a name="l00188"></a>00188                                         <span class="comment">#dx = lstsq(N,c)[0]</span>
<a name="l00189"></a>00189                                         dx = lstsq(G,dr)[0]
<a name="l00190"></a>00190 
<a name="l00191"></a>00191                                         self.<a class="code" href="classGPS_1_1GPSsensor.html#ab56fa5e908d023ed0086a77363371ab8">position</a>.x = self.<a class="code" href="classGPS_1_1GPSsensor.html#ab56fa5e908d023ed0086a77363371ab8">position</a>.x + dx[0]
<a name="l00192"></a>00192                                         self.<a class="code" href="classGPS_1_1GPSsensor.html#ab56fa5e908d023ed0086a77363371ab8">position</a>.y = self.<a class="code" href="classGPS_1_1GPSsensor.html#ab56fa5e908d023ed0086a77363371ab8">position</a>.y + dx[1]
<a name="l00193"></a>00193                                         self.<a class="code" href="classGPS_1_1GPSsensor.html#ab56fa5e908d023ed0086a77363371ab8">position</a>.z = self.<a class="code" href="classGPS_1_1GPSsensor.html#ab56fa5e908d023ed0086a77363371ab8">position</a>.z + dx[2]
<a name="l00194"></a>00194                                         self.<a class="code" href="classGPS_1_1GPSsensor.html#a0b9a8cf72706e87d26037580450e8783">ctime</a> = self.<a class="code" href="classGPS_1_1GPSsensor.html#a0b9a8cf72706e87d26037580450e8783">ctime</a> + dx[3]
<a name="l00195"></a>00195 
<a name="l00196"></a>00196                                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[0]=self.<a class="code" href="classGPS_1_1GPSsensor.html#ab56fa5e908d023ed0086a77363371ab8">position</a>.x
<a name="l00197"></a>00197                                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[2]=self.<a class="code" href="classGPS_1_1GPSsensor.html#ab56fa5e908d023ed0086a77363371ab8">position</a>.y
<a name="l00198"></a>00198                                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[4]=self.<a class="code" href="classGPS_1_1GPSsensor.html#ab56fa5e908d023ed0086a77363371ab8">position</a>.z
<a name="l00199"></a>00199                                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[6]=self.<a class="code" href="classGPS_1_1GPSsensor.html#a0b9a8cf72706e87d26037580450e8783">ctime</a>
<a name="l00200"></a>00200 
<a name="l00201"></a>00201                                 self.<a class="code" href="classGPS_1_1GPSsensor.html#ac54ce2f6f4e3ced3ed7be7ffccabd9d2">firstime</a>=<span class="keyword">False</span>
<a name="l00202"></a>00202 
<a name="l00203"></a>00203                         <span class="keywordflow">else</span>:
<a name="l00204"></a>00204                                 self.<a class="code" href="classGPS_1_1GPSsensor.html#aa2fe8f7d3366d7136f51df37390a3bff">getPositionKalman</a>()
<a name="l00205"></a>00205                                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.fix=1
<a name="l00206"></a>00206                                 <span class="keywordflow">if</span> (k&gt;0):
<a name="l00207"></a>00207                                         self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.fix=2
<a name="l00208"></a>00208                                 
<a name="l00209"></a>00209                                 <span class="comment">#for x in range(0,self.sats.visible):</span>
<a name="l00210"></a>00210                                 <span class="comment">#               cosine_vector.x=self.sats.sat[x].position.x-self.position.x</span>
<a name="l00211"></a>00211                                 <span class="comment">#               cosine_vector.y=self.sats.sat[x].position.y-self.position.y</span>
<a name="l00212"></a>00212                                 <span class="comment">#               cosine_vector.z=self.sats.sat[x].position.z-self.position.z</span>
<a name="l00213"></a>00213                                 <span class="comment">#               r_ref = sqrt(cosine_vector.x*cosine_vector.x+cosine_vector.y*cosine_vector.y+cosine_vector.z*cosine_vector.z)</span>
<a name="l00214"></a>00214 
<a name="l00215"></a>00215                                 <span class="comment">#               G[x,0] = -cosine_vector.x/r_ref</span>
<a name="l00216"></a>00216                                 <span class="comment">#               G[x,1] = -cosine_vector.y/r_ref</span>
<a name="l00217"></a>00217                                 <span class="comment">#               G[x,2] = -cosine_vector.z/r_ref</span>
<a name="l00218"></a>00218                                 <span class="comment">#               G[x,3] = 1.0</span>
<a name="l00219"></a>00219 
<a name="l00220"></a>00220                                 <span class="comment">#               dr[x] = self.sats.sat[x].range - r_ref -self.ctime#*lspeed</span>
<a name="l00221"></a>00221                                                 
<a name="l00222"></a>00222                                 <span class="comment">#N=np.dot(G.T,Rc)</span>
<a name="l00223"></a>00223                                 <span class="comment">#c=np.dot(N,dr)</span>
<a name="l00224"></a>00224                                 <span class="comment">#N=np.dot(N,G)</span>
<a name="l00225"></a>00225                                                 
<a name="l00226"></a>00226                                 <span class="comment">#dx = lstsq(N,c)[0]</span>
<a name="l00227"></a>00227                                 <span class="comment">#dx = lstsq(G,dr)[0]</span>
<a name="l00228"></a>00228 
<a name="l00229"></a>00229                                 <span class="comment">#self.position.x = self.position.x + dx[0]</span>
<a name="l00230"></a>00230                                 <span class="comment">#self.position.y = self.position.y + dx[1]</span>
<a name="l00231"></a>00231                                 <span class="comment">#self.position.z = self.position.z + dx[2]</span>
<a name="l00232"></a>00232                                 <span class="comment">#self.ctime = self.ctime + dx[3]#/lspeed</span>
<a name="l00233"></a>00233 
<a name="l00234"></a>00234                                 <span class="comment">#print &quot;pos&quot;</span>
<a name="l00235"></a>00235                                 <span class="comment">#print self.position.x-pos.x</span>
<a name="l00236"></a>00236                                 <span class="comment">#print self.position.y-pos.y</span>
<a name="l00237"></a>00237                                 <span class="comment">#print self.position.z-pos.z</span>
<a name="l00238"></a>00238                                 <span class="comment">#print self.ctime/lspeed</span>
<a name="l00239"></a>00239                                                                 
<a name="l00240"></a><a class="code" href="classGPS_1_1GPSsensor.html#a86d4643efd385cc61105fb6ea97b662a">00240</a>         <span class="keyword">def </span><a class="code" href="classGPS_1_1GPSsensor.html#a86d4643efd385cc61105fb6ea97b662a">calculateMeas</a>(self):
<a name="l00241"></a>00241                 
<a name="l00242"></a>00242                 sf= sin(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.latitude)
<a name="l00243"></a>00243                 cf = cos(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.latitude)
<a name="l00244"></a>00244                 sl= sin(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.longitude)
<a name="l00245"></a>00245                 cl = cos(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.longitude)
<a name="l00246"></a>00246 
<a name="l00247"></a>00247                 RNe=np.array([-sf*cl, -sf*sl, cf,
<a name="l00248"></a>00248                               -sl,    cl,     0.0,    
<a name="l00249"></a>00249                               -cf*cl, -cf*sl, -sf  ]).reshape(3,3)
<a name="l00250"></a>00250 
<a name="l00251"></a>00251                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.latitude, self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.longitude, self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.altitude = ECEF2lla(Vector3(self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[0],self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[2],self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[4]),Geoid. EARTH_radius,_earth_E)
<a name="l00252"></a>00252                 
<a name="l00253"></a>00253                 speedE = np.array([self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[1],self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[3],self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[5]]).reshape(3,)
<a name="l00254"></a>00254                 <span class="comment">#print RNe</span>
<a name="l00255"></a>00255                 speed = np.dot(RNe,speedE)
<a name="l00256"></a>00256 
<a name="l00257"></a>00257                 a2=-0.1
<a name="l00258"></a>00258                 b1=0.7
<a name="l00259"></a>00259                 b2=0.2
<a name="l00260"></a>00260                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a6696d86281702cdf71c63a20cd26d466">speed3</a>.x=-a2*self.<a class="code" href="classGPS_1_1GPSsensor.html#a6696d86281702cdf71c63a20cd26d466">speed3</a>.x+b1*speed[0]+b2*self.<a class="code" href="classGPS_1_1GPSsensor.html#a7547877bc18aa04b73c4ce118dae9825">speedold</a>[0]
<a name="l00261"></a>00261                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a6696d86281702cdf71c63a20cd26d466">speed3</a>.y=-a2*self.<a class="code" href="classGPS_1_1GPSsensor.html#a6696d86281702cdf71c63a20cd26d466">speed3</a>.y+b1*speed[1]+b2*self.<a class="code" href="classGPS_1_1GPSsensor.html#a7547877bc18aa04b73c4ce118dae9825">speedold</a>[1]
<a name="l00262"></a>00262                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a6696d86281702cdf71c63a20cd26d466">speed3</a>.z=-a2*self.<a class="code" href="classGPS_1_1GPSsensor.html#a6696d86281702cdf71c63a20cd26d466">speed3</a>.z+b1*speed[2]+b2*self.<a class="code" href="classGPS_1_1GPSsensor.html#a7547877bc18aa04b73c4ce118dae9825">speedold</a>[2]
<a name="l00263"></a>00263 
<a name="l00264"></a>00264                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a7547877bc18aa04b73c4ce118dae9825">speedold</a>=speed
<a name="l00265"></a>00265 
<a name="l00266"></a>00266                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.speed = sqrt(speed[0]*speed[0]+speed[1]*speed[1])*1.94384449<span class="comment">#sqrt(self.speed3.x*self.speed3.x+self.speed3.y*self.speed3.y)*1.94384449</span>
<a name="l00267"></a>00267                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.vspeed = speed[2]<span class="comment">#self.speed3.z</span>
<a name="l00268"></a>00268                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.course = atan2(speed[1],speed[0])*180.0/pi<span class="comment">#atan2(self.speed3.y,self.speed3.x)*180.0/pi</span>
<a name="l00269"></a>00269 
<a name="l00270"></a>00270 
<a name="l00271"></a>00271                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.header.stamp=rospy.Time.now()
<a name="l00272"></a>00272                 
<a name="l00273"></a>00273                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.latitude = floor(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.latitude/self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[0])*self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[0]
<a name="l00274"></a>00274                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.longitude = floor(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.longitude/self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[0])*self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[0] 
<a name="l00275"></a>00275                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.altitude = floor(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.altitude/self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[1])*self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[1]
<a name="l00276"></a>00276 
<a name="l00277"></a>00277                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.speed = floor(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.speed/self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[2])*self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[2]/1.94384449
<a name="l00278"></a>00278                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.vspeed = floor(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.vspeed/self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[2])*self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[2]
<a name="l00279"></a>00279                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.course = floor(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.course/self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[3])*self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[3]
<a name="l00280"></a>00280 
<a name="l00281"></a>00281                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.g = floor(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.g/self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[4])*self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[4]
<a name="l00282"></a>00282                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.p = floor(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.p/self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[4])*self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[4]
<a name="l00283"></a>00283                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.h = floor(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.h/self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[4])*self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[4]
<a name="l00284"></a>00284                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.v = floor(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.v/self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[4])*self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[4]
<a name="l00285"></a>00285                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.t = floor(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.dop.t/self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[4])*self.<a class="code" href="classGPS_1_1GPSsensor.html#a090c3ae2ec4b638640a4752fed713752">resolution</a>[4]
<a name="l00286"></a>00286                 
<a name="l00287"></a>00287                 
<a name="l00288"></a>00288                 self.pub.publish(self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>)
<a name="l00289"></a>00289                 
<a name="l00290"></a>00290                 <span class="comment">#self.av.append(self.position)</span>
<a name="l00291"></a>00291                 <span class="comment">#if (len(self.av)==self.maxcount):</span>
<a name="l00292"></a>00292                 <span class="comment">#       x=0.0</span>
<a name="l00293"></a>00293                 <span class="comment">#       y=0.0</span>
<a name="l00294"></a>00294                 <span class="comment">#       z=0.0</span>
<a name="l00295"></a>00295                 <span class="comment">#       self.count=0</span>
<a name="l00296"></a>00296                 <span class="comment">#       for avi in self.av:</span>
<a name="l00297"></a>00297                 <span class="comment">#               x=x+avi.x</span>
<a name="l00298"></a>00298                 <span class="comment">#               y=y+avi.y</span>
<a name="l00299"></a>00299                 <span class="comment">#               z=z+avi.z</span>
<a name="l00300"></a>00300 
<a name="l00301"></a>00301                 <span class="comment">#       x=x/float(self.maxcount)</span>
<a name="l00302"></a>00302                 <span class="comment">#       y=y/float(self.maxcount)</span>
<a name="l00303"></a>00303                 <span class="comment">#       z=z/float(self.maxcount)</span>
<a name="l00304"></a>00304                         
<a name="l00305"></a>00305                 <span class="comment">#       self.measurement.latitude, self.measurement.longitude, self.measurement.altitude = ECEF2lla(Vector3(x,y,z))</span>
<a name="l00306"></a>00306                         
<a name="l00307"></a>00307                         <span class="comment">#print (x-self.xyzold[0])/self.dt</span>
<a name="l00308"></a>00308                         <span class="comment">#print (y-self.xyzold[1])/self.dt</span>
<a name="l00309"></a>00309                         <span class="comment">#print (z-self.xyzold[2])/self.dt</span>
<a name="l00310"></a>00310                         <span class="comment">#self.xyzold[0]=x</span>
<a name="l00311"></a>00311                         <span class="comment">#self.xyzold[1]=y</span>
<a name="l00312"></a>00312                         <span class="comment">#self.xyzold[2]=z</span>
<a name="l00313"></a>00313                 <span class="comment">#       self.pub.publish(self.measurement)</span>
<a name="l00314"></a>00314                         
<a name="l00315"></a>00315                 <span class="comment">#       self.av=[]</span>
<a name="l00316"></a>00316 
<a name="l00317"></a><a class="code" href="classGPS_1_1GPSsensor.html#a1a06ce6cb8bf60495393dfb1551eb3f2">00317</a>         <span class="keyword">def </span><a class="code" href="classGPS_1_1GPSsensor.html#a1a06ce6cb8bf60495393dfb1551eb3f2">iterate</a>(self,states):
<a name="l00318"></a>00318                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a97353bfddf67c4d20c9b178023576c25">measurement</a>.fix=0
<a name="l00319"></a>00319                 
<a name="l00320"></a>00320                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a67bfe73d53aad63bb83638993ca589d3">place</a>.lat = states.geoid.latitude
<a name="l00321"></a>00321                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a67bfe73d53aad63bb83638993ca589d3">place</a>.long = states.geoid.longitude
<a name="l00322"></a>00322                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a67bfe73d53aad63bb83638993ca589d3">place</a>.elevation = states.geoid.altitude
<a name="l00323"></a>00323                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a67bfe73d53aad63bb83638993ca589d3">place</a>.date = datetime.datetime.now()
<a name="l00324"></a>00324 
<a name="l00325"></a>00325                 pos = lla2ECEF(self.<a class="code" href="classGPS_1_1GPSsensor.html#a67bfe73d53aad63bb83638993ca589d3">place</a>.lat,self.<a class="code" href="classGPS_1_1GPSsensor.html#a67bfe73d53aad63bb83638993ca589d3">place</a>.long,self.<a class="code" href="classGPS_1_1GPSsensor.html#a67bfe73d53aad63bb83638993ca589d3">place</a>.elevation,Geoid. EARTH_radius,_earth_E)
<a name="l00326"></a>00326 
<a name="l00327"></a>00327                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible=0
<a name="l00328"></a>00328 
<a name="l00329"></a>00329                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a967cc0e49b69c168d656bff9baf2264c">getVisible</a>(pos,self.sat_sbas)
<a name="l00330"></a>00330                 k=self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible
<a name="l00331"></a>00331                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a967cc0e49b69c168d656bff9baf2264c">getVisible</a>(pos,self.<a class="code" href="classGPS_1_1GPSsensor.html#a48d3b88d9055a98bd6abbef75d959f4e">sat_gpsop</a>)
<a name="l00332"></a>00332 
<a name="l00333"></a>00333                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a976db5cef756a2815c8549193bd4cf3b">setNoise</a>()
<a name="l00334"></a>00334 
<a name="l00335"></a>00335                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a4a94041e216ee9b04e79e319cc3e4ccc">getPosition</a>(k)
<a name="l00336"></a>00336 
<a name="l00337"></a>00337                 self.<a class="code" href="classGPS_1_1GPSsensor.html#ad473e31618d88c61f8774fe3c99b53d0">getdop</a>(self.<a class="code" href="classGPS_1_1GPSsensor.html#ab56fa5e908d023ed0086a77363371ab8">position</a>)
<a name="l00338"></a>00338 
<a name="l00339"></a>00339                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a86d4643efd385cc61105fb6ea97b662a">calculateMeas</a>()
<a name="l00340"></a>00340                 
<a name="l00341"></a>00341 
<a name="l00342"></a><a class="code" href="classGPS_1_1GPSsensor.html#a0308af7c2a2b3ca417090ce23ae90853">00342</a>         <span class="keyword">def </span><a class="code" href="classGPS_1_1GPSsensor.html#a0308af7c2a2b3ca417090ce23ae90853">StatesCallback</a>(self,data):
<a name="l00343"></a>00343                 self.<a class="code" href="classGPS_1_1GPSsensor.html#aafeca97af6dcdb1d2165883856bb7c4f">real</a>=data
<a name="l00344"></a>00344                 self.<a class="code" href="classGPS_1_1GPSsensor.html#ab76439a80d520b146ae80ff5c11bacbf">realnew</a>=<span class="keyword">True</span>
<a name="l00345"></a>00345                 
<a name="l00346"></a>00346 
<a name="l00347"></a><a class="code" href="classGPS_1_1GPSsensor.html#aa2fe8f7d3366d7136f51df37390a3bff">00347</a>         <span class="keyword">def </span><a class="code" href="classGPS_1_1GPSsensor.html#aa2fe8f7d3366d7136f51df37390a3bff">getPositionKalman</a>(self):
<a name="l00348"></a>00348                 <span class="comment">#Model Propagation</span>
<a name="l00349"></a>00349                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[0] =  self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[0] + self.<a class="code" href="classGPS_1_1GPSsensor.html#ad68944d1e7004cf2787faf8ca7935249">dt</a>*self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[1]
<a name="l00350"></a>00350                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[2] =  self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[2] + self.<a class="code" href="classGPS_1_1GPSsensor.html#ad68944d1e7004cf2787faf8ca7935249">dt</a>*self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[3]
<a name="l00351"></a>00351                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[4] =  self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[4] + self.<a class="code" href="classGPS_1_1GPSsensor.html#ad68944d1e7004cf2787faf8ca7935249">dt</a>*self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[5]
<a name="l00352"></a>00352                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[6] =  self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[6] + self.<a class="code" href="classGPS_1_1GPSsensor.html#ad68944d1e7004cf2787faf8ca7935249">dt</a>*self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[7]
<a name="l00353"></a>00353 
<a name="l00354"></a>00354                 <span class="comment">#Sensor Model</span>
<a name="l00355"></a>00355                 Jz = np.zeros((self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible,8))
<a name="l00356"></a>00356                 ze = np.zeros((self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible,))
<a name="l00357"></a>00357                 Zm = np.zeros((self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible,))
<a name="l00358"></a>00358                 <span class="keywordflow">for</span> i <span class="keywordflow">in</span> range(0,self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible):
<a name="l00359"></a>00359                         dx=self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[0]-self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[i].position.x
<a name="l00360"></a>00360                         dy=self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[2]-self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[i].position.y
<a name="l00361"></a>00361                         dz=self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[4]-self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[i].position.z
<a name="l00362"></a>00362                         ze[i]=sqrt(dx*dx+dy*dy+dz*dz)
<a name="l00363"></a>00363                         Jz[i,0]=dx/ze[i]
<a name="l00364"></a>00364                         Jz[i,2]=dy/ze[i]
<a name="l00365"></a>00365                         Jz[i,4]=dz/ze[i]
<a name="l00366"></a>00366                         Jz[i,6]=1.0
<a name="l00367"></a>00367                         Zm[i] = self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.sat[i].range
<a name="l00368"></a>00368                         ze[i]= ze[i] + self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a>[6]
<a name="l00369"></a>00369 
<a name="l00370"></a>00370                 R=self.<a class="code" href="classGPS_1_1GPSsensor.html#af26a4026fc5a1bb274131604b11c43fa">KR</a>*np.eye(self.<a class="code" href="classGPS_1_1GPSsensor.html#a74d3111a20e6d80a95ceb61a5eec6eb2">sats</a>.visible)
<a name="l00371"></a>00371 
<a name="l00372"></a>00372                 <span class="comment">#Kalman P,K</span>
<a name="l00373"></a>00373                 self.<a class="code" href="classGPS_1_1GPSsensor.html#ae656549db04a1292c0cab57b550b2ddc">KP</a> = np.dot(self.<a class="code" href="classGPS_1_1GPSsensor.html#a2126a098243eee84d353ff31f8bcd745">Jx</a>,np.dot(self.<a class="code" href="classGPS_1_1GPSsensor.html#ae656549db04a1292c0cab57b550b2ddc">KP</a>,self.<a class="code" href="classGPS_1_1GPSsensor.html#a2126a098243eee84d353ff31f8bcd745">Jx</a>.T)) + self.<a class="code" href="classGPS_1_1GPSsensor.html#a0a773e0ce7bc9647301cf9b917d6507c">KQ</a>
<a name="l00374"></a>00374                 
<a name="l00375"></a>00375                 K1 = np.dot(self.<a class="code" href="classGPS_1_1GPSsensor.html#ae656549db04a1292c0cab57b550b2ddc">KP</a>,Jz.T)
<a name="l00376"></a>00376                 K2 = np.dot(Jz,np.dot(self.<a class="code" href="classGPS_1_1GPSsensor.html#ae656549db04a1292c0cab57b550b2ddc">KP</a>,Jz.T))+R
<a name="l00377"></a>00377 
<a name="l00378"></a>00378                 K = np.dot(K1,inv(K2))
<a name="l00379"></a>00379 
<a name="l00380"></a>00380                 <span class="comment">#New P, states</span>
<a name="l00381"></a>00381                 self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a> = self.<a class="code" href="classGPS_1_1GPSsensor.html#a550c6a0c51a628f982c002c2ea44f5fe">Kstates</a> + 0.8*np.dot(K,(Zm-ze))
<a name="l00382"></a>00382                 
<a name="l00383"></a>00383                 self.<a class="code" href="classGPS_1_1GPSsensor.html#ae656549db04a1292c0cab57b550b2ddc">KP</a> = np.dot((np.eye(8)-np.dot(K,Jz)),self.<a class="code" href="classGPS_1_1GPSsensor.html#ae656549db04a1292c0cab57b550b2ddc">KP</a>)
<a name="l00384"></a>00384                 
<a name="l00385"></a>00385 <span class="comment">###################################################################################################     </span>
<a name="l00386"></a>00386 <span class="comment">#######################  Main Program  ############################################################</span>
<a name="l00387"></a>00387 <span class="comment">###################################################################################################     </span>
<a name="l00388"></a>00388 <span class="keywordflow">if</span> __name__ == <span class="stringliteral">&#39;__main__&#39;</span>:
<a name="l00389"></a>00389         rospy.init_node(<span class="stringliteral">&#39;acc_model&#39;</span>)
<a name="l00390"></a>00390 
<a name="l00391"></a><a class="code" href="namespaceGPS.html#abc633cc7061e2306e869d5f548210431">00391</a>         fullname = rospy.get_name().split(<span class="stringliteral">&#39;/&#39;</span>)
<a name="l00392"></a><a class="code" href="namespaceGPS.html#a3812f4a43a515dfac30d08a441c1e668">00392</a>         gps = <a class="code" href="classGPS_1_1GPSsensor.html" title="Magnetometer Class #####################################################.">GPSsensor</a>(fullname[-1])
<a name="l00393"></a>00393 
<a name="l00394"></a><a class="code" href="namespaceGPS.html#a33511b17394518b826a96cb3861e84ed">00394</a>         maxcount = gps.dt/gps.maxdt
<a name="l00395"></a>00395 
<a name="l00396"></a>00396         <span class="keywordflow">while</span> <span class="keywordflow">not</span> rospy.is_shutdown():
<a name="l00397"></a>00397                 <span class="keywordflow">if</span> gps.realnew:
<a name="l00398"></a>00398                         gps.realnew=<span class="keyword">False</span>
<a name="l00399"></a>00399                         gps.iterate(gps.real)
<a name="l00400"></a>00400                         gps.measurement.header.stamp=rospy.Time.now()
<a name="l00401"></a>00401 
<a name="l00402"></a>00402                 <span class="comment">#if (count==maxcount):</span>
<a name="l00403"></a>00403                 <span class="comment">#       count=0</span>
<a name="l00404"></a>00404                 <span class="comment">#       gps.pub.publish(gps.measurement)</span>
<a name="l00405"></a>00405                 gps.maxrate.sleep()
</pre></div></div><!-- contents -->

<br clear="all" />
<hr size="1"><div style="align: right;">
<a href="http://wiki.ros.org/last_letter">last_letter</a><br />
Author(s): George Zogopoulos Papaliakos <gzogop@mail.ntua.gr>, Panos Marantos</br />
<small>autogenerated on Mon Feb 23 2015 00:50:17</small>
</div>
</body>
</html>
