<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>last_letter: fdmUDPSend.py Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">


</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">fdmUDPSend.py</div>  </div>
</div><!--header-->
<div class="contents">
<a href="fdmUDPSend_8py.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a><a class="code" href="namespacefdmUDPSend.html">00001</a> <span class="comment">#!/usr/bin/env python</span>
<a name="l00002"></a>00002 <span class="comment"># Send simState data as a UDP stream, packed as an FG_FDM object</span>
<a name="l00003"></a>00003 <span class="comment"># Based on runsim.py by Ardupilot Tools git</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="keyword">import</span> roslib
<a name="l00006"></a>00006 <span class="keyword">import</span> sys
<a name="l00007"></a>00007 <span class="keyword">import</span> rospy
<a name="l00008"></a>00008 <span class="keyword">from</span> geometry_msgs.msg <span class="keyword">import</span> Vector3, Vector3Stamped
<a name="l00009"></a>00009 <span class="keyword">import</span> numpy <span class="keyword">as</span> np
<a name="l00010"></a>00010 <span class="keyword">import</span> tf.transformations
<a name="l00011"></a>00011 <span class="keyword">from</span> mathutils <span class="keyword">import</span> quat2Reb, Vector2Array
<a name="l00012"></a>00012 <span class="keyword">from</span> last_letter.msg <span class="keyword">import</span> SimStates, SimPWM, Environment
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="keyword">from</span> pymavlink <span class="keyword">import</span> fgFDM
<a name="l00015"></a>00015 <span class="keyword">import</span> socket, struct, errno
<a name="l00016"></a>00016 
<a name="l00017"></a><a class="code" href="namespacefdmUDPSend.html#a688a5c5f259e0141d791a9db8b3b5306">00017</a> <span class="keyword">def </span><a class="code" href="namespacefdmUDPSend.html#a688a5c5f259e0141d791a9db8b3b5306">interpret_address</a>(addrstr):
<a name="l00018"></a>00018     <span class="stringliteral">&#39;&#39;&#39;interpret a IP:port string&#39;&#39;&#39;</span>
<a name="l00019"></a>00019     a = addrstr.split(<span class="stringliteral">&#39;:&#39;</span>)
<a name="l00020"></a>00020     a[1] = int(a[1])
<a name="l00021"></a>00021     <span class="keywordflow">return</span> tuple(a)
<a name="l00022"></a>00022 
<a name="l00023"></a><a class="code" href="namespacefdmUDPSend.html#a5a054c738f0dc1652f0b8ac18175af83">00023</a> <span class="keyword">def </span><a class="code" href="namespacefdmUDPSend.html#a5a054c738f0dc1652f0b8ac18175af83">state_callback</a>(state):
<a name="l00024"></a>00024 
<a name="l00025"></a>00025         <span class="keyword">global</span> fdm, stateStorage
<a name="l00026"></a>00026 
<a name="l00027"></a>00027         stateStorage = state
<a name="l00028"></a>00028 
<a name="l00029"></a>00029         fdm.set(<span class="stringliteral">&#39;latitude&#39;</span>, state.geoid.latitude, units=<span class="stringliteral">&#39;degrees&#39;</span>)
<a name="l00030"></a>00030         fdm.set(<span class="stringliteral">&#39;longitude&#39;</span>, state.geoid.longitude, units=<span class="stringliteral">&#39;degrees&#39;</span>)
<a name="l00031"></a>00031         fdm.set(<span class="stringliteral">&#39;altitude&#39;</span>, state.geoid.altitude, units=<span class="stringliteral">&#39;meters&#39;</span>)
<a name="l00032"></a>00032         <span class="comment"># rospy.logerr(&#39;Lat/Lon/Alt: %g/%g/%g&#39;,state.geoid.latitude, state.geoid.longitude, state.geoid.altitude)</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034         fdm.set(<span class="stringliteral">&#39;v_north&#39;</span>, state.geoid.velocity.x, units=<span class="stringliteral">&#39;mps&#39;</span>)
<a name="l00035"></a>00035         fdm.set(<span class="stringliteral">&#39;v_east&#39;</span>, state.geoid.velocity.y, units=<span class="stringliteral">&#39;mps&#39;</span>)
<a name="l00036"></a>00036         fdm.set(<span class="stringliteral">&#39;v_down&#39;</span>, -state.geoid.velocity.z, units=<span class="stringliteral">&#39;mps&#39;</span>) <span class="comment"># Downwards velocity</span>
<a name="l00037"></a>00037         <span class="comment"># rospy.logerr(&#39;vn/ve/vd: %g/%g/%g&#39;,state.geoid.velocity.x, state.geoid.velocity.y, -state.geoid.velocity.z)</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039         <span class="comment"># Calculate accelerometer felt accelerations</span>
<a name="l00040"></a>00040         <span class="comment"># Reb = quat2Reb(state.pose.orientation)</span>
<a name="l00041"></a>00041         <span class="comment"># accx = (state.acceleration.linear.x - 9.80665*Reb[2][0])</span>
<a name="l00042"></a>00042         <span class="comment"># accy = (state.acceleration.linear.y - 9.80665*Reb[2][1])</span>
<a name="l00043"></a>00043         <span class="comment"># accz = (state.acceleration.linear.z - 9.80665*Reb[2][2])</span>
<a name="l00044"></a>00044         <span class="comment"># fdm.set(&#39;A_X_pilot&#39;, accx, units=&#39;mpss&#39;)</span>
<a name="l00045"></a>00045         <span class="comment"># fdm.set(&#39;A_Y_pilot&#39;, accy, units=&#39;mpss&#39;)</span>
<a name="l00046"></a>00046         <span class="comment"># fdm.set(&#39;A_Z_pilot&#39;, accz, units=&#39;mpss&#39;)</span>
<a name="l00047"></a>00047         <span class="comment"># rospy.logerr(&#39;acc_x/y/z: %g/%g/%g&#39;,accx, accy, accz)</span>
<a name="l00048"></a>00048 
<a name="l00049"></a>00049         (yaw, pitch, roll) = tf.transformations.euler_from_quaternion([state.pose.orientation.x, state.pose.orientation.y, state.pose.orientation.z, state.pose.orientation.w],<span class="stringliteral">&#39;rzyx&#39;</span>)
<a name="l00050"></a>00050         fdm.set(<span class="stringliteral">&#39;phi&#39;</span>, roll, units=<span class="stringliteral">&#39;radians&#39;</span>)
<a name="l00051"></a>00051         fdm.set(<span class="stringliteral">&#39;theta&#39;</span>, pitch, units=<span class="stringliteral">&#39;radians&#39;</span>)
<a name="l00052"></a>00052         fdm.set(<span class="stringliteral">&#39;psi&#39;</span>, yaw, units=<span class="stringliteral">&#39;radians&#39;</span>)
<a name="l00053"></a>00053         <span class="comment"># rospy.logerr(&#39;r/p/y: %4.1f/%4.1f/%4.1f&#39;,180/np.pi*roll, 180/np.pi*pitch, 180/np.pi*yaw)</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055         (p, q, r) = (state.velocity.angular.x, state.velocity.angular.y, state.velocity.angular.z)
<a name="l00056"></a>00056         phiDot = p + np.tan(pitch)*np.sin(roll)*q + np.tan(pitch)*np.cos(roll)*r
<a name="l00057"></a>00057         thetaDot = np.cos(roll)*q - np.sin(roll)*r
<a name="l00058"></a>00058         psiDot = np.sin(roll)/np.cos(pitch)*q + np.cos(roll)/np.cos(pitch)*r
<a name="l00059"></a>00059 
<a name="l00060"></a>00060         fdm.set(<span class="stringliteral">&#39;phidot&#39;</span>, phiDot, units=<span class="stringliteral">&#39;rps&#39;</span>)
<a name="l00061"></a>00061         fdm.set(<span class="stringliteral">&#39;thetadot&#39;</span>, thetaDot, units=<span class="stringliteral">&#39;rps&#39;</span>)
<a name="l00062"></a>00062         fdm.set(<span class="stringliteral">&#39;psidot&#39;</span>, psiDot, units=<span class="stringliteral">&#39;rps&#39;</span>)
<a name="l00063"></a>00063         <span class="comment"># rospy.logerr(&#39;dot_phi/theta/psi: %g/%g/%g&#39;,phiDot, thetaDot, psiDot)</span>
<a name="l00064"></a>00064 
<a name="l00065"></a>00065         vcas = np.sqrt(state.velocity.linear.x*state.velocity.linear.x + state.velocity.linear.y*state.velocity.linear.y + state.velocity.linear.z*state.velocity.linear.z)
<a name="l00066"></a>00066         fdm.set(<span class="stringliteral">&#39;vcas&#39;</span>, vcas, units=<span class="stringliteral">&#39;mps&#39;</span>) <span class="comment"># Needs to take wind into account!</span>
<a name="l00067"></a>00067         <span class="comment"># rospy.logerr(&#39;vcas: %g&#39;,vcas)</span>
<a name="l00068"></a>00068 
<a name="l00069"></a>00069         fdm.set(<span class="stringliteral">&#39;rpm&#39;</span>, state.rotorspeed[0]*np.pi*60)
<a name="l00070"></a>00070         fdm.set(<span class="stringliteral">&#39;agl&#39;</span>, state.geoid.altitude, units=<span class="stringliteral">&#39;meters&#39;</span>)
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="namespacefdmUDPSend.html#aef5d8ca2adb9b959cbf1a47dd16c94fe">00072</a> <span class="keyword">def </span><a class="code" href="namespacefdmUDPSend.html#aef5d8ca2adb9b959cbf1a47dd16c94fe">accel_callback</a>(accel):
<a name="l00073"></a>00073 
<a name="l00074"></a>00074         <span class="keyword">global</span> fdm, stateStorage
<a name="l00075"></a>00075         Reb = quat2Reb(stateStorage.pose.orientation)
<a name="l00076"></a>00076         accx = (accel.x - 9.80665*Reb[2][0])
<a name="l00077"></a>00077         accy = (accel.y - 9.80665*Reb[2][1])
<a name="l00078"></a>00078         accz = (accel.z - 9.80665*Reb[2][2])
<a name="l00079"></a>00079         fdm.set(<span class="stringliteral">&#39;A_X_pilot&#39;</span>, accx, units=<span class="stringliteral">&#39;mpss&#39;</span>)
<a name="l00080"></a>00080         fdm.set(<span class="stringliteral">&#39;A_Y_pilot&#39;</span>, accy, units=<span class="stringliteral">&#39;mpss&#39;</span>)
<a name="l00081"></a>00081         fdm.set(<span class="stringliteral">&#39;A_Z_pilot&#39;</span>, accz, units=<span class="stringliteral">&#39;mpss&#39;</span>)
<a name="l00082"></a>00082         <span class="comment"># rospy.logerr(&#39;acc_x/y/z: %g/%g/%g&#39;,accx, accy, accz)</span>
<a name="l00083"></a>00083 
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="comment">########</span>
<a name="l00086"></a>00086 <span class="comment">## Setup</span>
<a name="l00087"></a>00087 <span class="comment">########</span>
<a name="l00088"></a>00088 
<a name="l00089"></a><a class="code" href="namespacefdmUDPSend.html#ab84c9a4ab34c1f402d85ee3e7eca94e0">00089</a> jsb_in_address = <span class="stringliteral">&quot;127.0.0.1:5504&quot;</span> <span class="comment"># FDM data coming out of the ROS Simulator</span>
<a name="l00090"></a><a class="code" href="namespacefdmUDPSend.html#ab246abeb752b74946c901fc1e7e1fb4b">00090</a> jsb_in = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
<a name="l00091"></a>00091 jsb_in.connect(<a class="code" href="namespacefdmUDPSend.html#a688a5c5f259e0141d791a9db8b3b5306">interpret_address</a>(jsb_in_address)) <span class="comment"># Should I use connect?</span>
<a name="l00092"></a>00092 
<a name="l00093"></a><a class="code" href="namespacefdmUDPSend.html#a61bd7ae5f07713c5ee7a02d7abfd3814">00093</a> fdm = fgFDM.fgFDM() <span class="comment"># Create fdm objects</span>
<a name="l00094"></a>00094 
<a name="l00095"></a>00095 <span class="comment">###############</span>
<a name="l00096"></a>00096 <span class="comment">## Main Program</span>
<a name="l00097"></a>00097 <span class="comment">###############</span>
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 <span class="keywordflow">if</span> __name__ == <span class="stringliteral">&#39;__main__&#39;</span>:
<a name="l00100"></a>00100         <span class="keywordflow">try</span>:
<a name="l00101"></a>00101                 rospy.init_node(<span class="stringliteral">&#39;fdmUDPSend&#39;</span>)
<a name="l00102"></a>00102                 rospy.Subscriber(<span class="stringliteral">&#39;states&#39;</span>, SimStates, state_callback, queue_size=1)
<a name="l00103"></a>00103                 rospy.Subscriber(<span class="stringliteral">&#39;linearAcc&#39;</span>, Vector3, accel_callback, queue_size=1)
<a name="l00104"></a><a class="code" href="namespacefdmUDPSend.html#af75884e0daf3ffa1071793349d4b50e8">00104</a>                 timer = rospy.Rate(1000)
<a name="l00105"></a><a class="code" href="namespacefdmUDPSend.html#af70eb610cce1dd31899e275354ce0b02">00105</a>                 stateStorage = SimStates()
<a name="l00106"></a>00106 
<a name="l00107"></a>00107                 <span class="keywordflow">while</span> <span class="keywordflow">not</span> rospy.is_shutdown():
<a name="l00108"></a>00108                         <span class="keywordflow">try</span>:
<a name="l00109"></a>00109                                 jsb_in.send(fdm.pack())
<a name="l00110"></a>00110                         <span class="keywordflow">except</span> socket.error <span class="keyword">as</span> e:
<a name="l00111"></a>00111                                 <span class="keywordflow">if</span> e.errno <span class="keywordflow">not</span> <span class="keywordflow">in</span> [ errno.ECONNREFUSED ]:
<a name="l00112"></a>00112                                         <span class="keywordflow">print</span> <span class="stringliteral">&quot;error on jsb_in sending&quot;</span>
<a name="l00113"></a>00113                                         <span class="keywordflow">raise</span>
<a name="l00114"></a>00114                         timer.sleep()
<a name="l00115"></a>00115 
<a name="l00116"></a>00116                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;this node is pretty much dead&quot;</span>
<a name="l00117"></a>00117 
<a name="l00118"></a>00118         <span class="keywordflow">except</span> rospy.ROSInterruptException:
<a name="l00119"></a>00119                 <span class="keywordflow">print</span> <span class="stringliteral">&quot;something bad happened&quot;</span>
<a name="l00120"></a>00120                 <span class="keywordflow">pass</span>
</pre></div></div><!-- contents -->

<br clear="all" />
<hr size="1"><div style="align: right;">
<a href="http://wiki.ros.org/last_letter">last_letter</a><br />
Author(s): George Zogopoulos Papaliakos <gzogop@mail.ntua.gr>, Panos Marantos</br />
<small>autogenerated on Mon Feb 23 2015 00:50:17</small>
</div>
</body>
</html>
