<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>last_letter: propulsionLib.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">


</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.6.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">propulsionLib.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="propulsionLib_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <span class="comment">// Propulsion interfrace class</span>
<a name="l00004"></a>00004 <span class="comment"></span>
<a name="l00005"></a>00005 <span class="comment">// Constructor</span>
<a name="l00006"></a><a class="code" href="classPropulsion.html#a0dd47e2bc1e547c7e20cda093f2d30be">00006</a> <a class="code" href="classPropulsion.html#a0dd47e2bc1e547c7e20cda093f2d30be">Propulsion::Propulsion</a>(<a class="code" href="classModelPlane.html">ModelPlane</a> * parent)
<a name="l00007"></a>00007 {
<a name="l00008"></a>00008         <a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a> = parent;
<a name="l00009"></a>00009         XmlRpc::XmlRpcValue list;
<a name="l00010"></a>00010         <span class="keywordtype">int</span> i;
<a name="l00011"></a>00011         <span class="keywordflow">if</span>(!ros::param::getCached(<span class="stringliteral">&quot;motor/CGOffset&quot;</span>, list)) {ROS_FATAL(<span class="stringliteral">&quot;Invalid parameters for -motor/CGOffset- in param server!&quot;</span>); ros::shutdown();}
<a name="l00012"></a>00012         <span class="keywordflow">for</span> (i = 0; i &lt; list.size(); ++i) {
<a name="l00013"></a>00013                 ROS_ASSERT(list[i].getType() == XmlRpc::XmlRpcValue::TypeDouble);
<a name="l00014"></a>00014         }
<a name="l00015"></a>00015         <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.x = list[0];
<a name="l00016"></a>00016         <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.y = list[1];
<a name="l00017"></a>00017         <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.z = list[2];
<a name="l00018"></a>00018 }
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="comment">// Destructor</span>
<a name="l00021"></a><a class="code" href="classPropulsion.html#ae672244d25e3ddb8c2bc78d2afd8104f">00021</a> <a class="code" href="classPropulsion.html#ae672244d25e3ddb8c2bc78d2afd8104f">Propulsion::~Propulsion</a>()
<a name="l00022"></a>00022 {
<a name="l00023"></a>00023         <span class="keyword">delete</span> <a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>;
<a name="l00024"></a>00024 }
<a name="l00025"></a>00025 
<a name="l00027"></a>00027 <span class="comment">// No Engine Model</span>
<a name="l00029"></a>00029 <span class="comment"></span>
<a name="l00030"></a>00030 <span class="comment">// Constructor</span>
<a name="l00031"></a><a class="code" href="classNoEngine.html#a34ca17d4eb0f33bee8f335b0e8540c08">00031</a> <a class="code" href="classNoEngine.html#a34ca17d4eb0f33bee8f335b0e8540c08">NoEngine::NoEngine</a>(<a class="code" href="classModelPlane.html">ModelPlane</a> * parent) : <a class="code" href="classPropulsion.html">Propulsion</a>(parent)
<a name="l00032"></a>00032 {
<a name="l00033"></a>00033         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.x = 0.0;
<a name="l00034"></a>00034         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.y = 0.0;
<a name="l00035"></a>00035         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.z = 0.0;
<a name="l00036"></a>00036         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.x = 0.0;
<a name="l00037"></a>00037         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.y = 0.0;
<a name="l00038"></a>00038         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.z = 0.0;
<a name="l00039"></a>00039         <a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a> = 0.0;
<a name="l00040"></a>00040 }
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="comment">// Destructor</span>
<a name="l00043"></a><a class="code" href="classNoEngine.html#a2c79c87a31f0591d1a47e6363299e291">00043</a> <a class="code" href="classNoEngine.html#a2c79c87a31f0591d1a47e6363299e291">NoEngine::~NoEngine</a>()
<a name="l00044"></a>00044 {
<a name="l00045"></a>00045 }
<a name="l00046"></a>00046 
<a name="l00047"></a><a class="code" href="classNoEngine.html#a593d6e8bb549bec5c2befdac4ef3321b">00047</a> <span class="keywordtype">void</span> <a class="code" href="classNoEngine.html#a593d6e8bb549bec5c2befdac4ef3321b">NoEngine::updateRadPS</a>()
<a name="l00048"></a>00048 {
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="comment">// Force calculation function</span>
<a name="l00052"></a><a class="code" href="classNoEngine.html#ab7ce37970b781e28070c66ab05fe46a3">00052</a> geometry_msgs::Vector3 <a class="code" href="classNoEngine.html#ab7ce37970b781e28070c66ab05fe46a3">NoEngine::getForce</a>()
<a name="l00053"></a>00053 {
<a name="l00054"></a>00054         <span class="keywordflow">return</span> <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force;
<a name="l00055"></a>00055 }
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="comment">// Torque calculation function</span>
<a name="l00058"></a><a class="code" href="classNoEngine.html#addcf504756fb2c879a66c1bb53ed426a">00058</a> geometry_msgs::Vector3 <a class="code" href="classNoEngine.html#addcf504756fb2c879a66c1bb53ed426a">NoEngine::getTorque</a>()
<a name="l00059"></a>00059 {
<a name="l00060"></a>00060         <span class="keywordflow">return</span> <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque;
<a name="l00061"></a>00061 }
<a name="l00062"></a>00062 
<a name="l00064"></a>00064 <span class="comment">// Engine model found in R. Beard&#39;s book</span>
<a name="l00066"></a>00066 <span class="comment"></span>
<a name="l00067"></a>00067 <span class="comment">// Constructor</span>
<a name="l00068"></a><a class="code" href="classEngBeard.html#a5b9a7d770df6b8375d07dc2e8581670c">00068</a> <a class="code" href="classEngBeard.html#a5b9a7d770df6b8375d07dc2e8581670c">EngBeard::EngBeard</a>(<a class="code" href="classModelPlane.html">ModelPlane</a> * parent):<a class="code" href="classPropulsion.html">Propulsion</a>(parent)
<a name="l00069"></a>00069 {
<a name="l00070"></a>00070         std::cout &lt;&lt; <span class="stringliteral">&quot;reading parameters for new Beard engine&quot;</span> &lt;&lt; std::endl;
<a name="l00071"></a>00071         <a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a> = 0; <span class="comment">// Initialize engine rotational speed</span>
<a name="l00072"></a>00072         <span class="comment">// Read engine data from parameter server</span>
<a name="l00073"></a>00073         <span class="keywordflow">if</span>(!ros::param::getCached(<span class="stringliteral">&quot;motor/s_prop&quot;</span>, <a class="code" href="classEngBeard.html#a54fdd7e06a72fc40cd1b7736e3ac3f91">s_prop</a>)) {ROS_FATAL(<span class="stringliteral">&quot;Invalid parameters for -s_prop- in param server!&quot;</span>); ros::shutdown();}
<a name="l00074"></a>00074         <span class="keywordflow">if</span>(!ros::param::getCached(<span class="stringliteral">&quot;motor/c_prop&quot;</span>, <a class="code" href="classEngBeard.html#a8ce6c3fd8c779ff7197ff0e6e8835ee7">c_prop</a>)) {ROS_FATAL(<span class="stringliteral">&quot;Invalid parameters for -c_prop- in param server!&quot;</span>); ros::shutdown();}
<a name="l00075"></a>00075         <span class="keywordflow">if</span>(!ros::param::getCached(<span class="stringliteral">&quot;motor/k_motor&quot;</span>, <a class="code" href="classEngBeard.html#acbeca43ea5954044964b9bd1cbf6d671">k_motor</a>)) {ROS_FATAL(<span class="stringliteral">&quot;Invalid parameters for -k_motor- in param server!&quot;</span>); ros::shutdown();}
<a name="l00076"></a>00076         <span class="keywordflow">if</span>(!ros::param::getCached(<span class="stringliteral">&quot;motor/k_t_p&quot;</span>, <a class="code" href="classEngBeard.html#a1fc1178d50c4f7a5184723d63edacd66">k_t_p</a>)) {ROS_FATAL(<span class="stringliteral">&quot;Invalid parameters for -k_t_p- in param server!&quot;</span>); ros::shutdown();}
<a name="l00077"></a>00077         <span class="keywordflow">if</span>(!ros::param::getCached(<span class="stringliteral">&quot;motor/k_omega&quot;</span>, <a class="code" href="classEngBeard.html#a7f4cf5ff0ed2f8720ce3fa47d3a9c9e1">k_omega</a>)) {ROS_FATAL(<span class="stringliteral">&quot;Invalid parameters for -k_omega- in param server!&quot;</span>); ros::shutdown();}
<a name="l00078"></a>00078 }
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 <span class="comment">// Destructor</span>
<a name="l00081"></a><a class="code" href="classEngBeard.html#abca0e65c41a4860f57404214bc5be234">00081</a> <a class="code" href="classEngBeard.html#abca0e65c41a4860f57404214bc5be234">EngBeard::~EngBeard</a>()
<a name="l00082"></a>00082 {
<a name="l00083"></a>00083 }
<a name="l00084"></a>00084 
<a name="l00085"></a>00085 <span class="comment">// Update motor rotational speed and other states for each timestep</span>
<a name="l00086"></a><a class="code" href="classEngBeard.html#a667623ffa15f245f4a2699f052790cef">00086</a> <span class="keywordtype">void</span> <a class="code" href="classEngBeard.html#a667623ffa15f245f4a2699f052790cef">EngBeard::updateRadPS</a>()
<a name="l00087"></a>00087 {
<a name="l00088"></a>00088         <a class="code" href="classEngBeard.html#a5044761e486ca0717564e38166d86ebc">rho</a> = <a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>-&gt;<a class="code" href="classModelPlane.html#a3659963ee4b42cf72492096e6dd02f01">environment</a>.density;
<a name="l00089"></a>00089         <a class="code" href="classEngBeard.html#ae2553230c21681298b084749b7c07f96">deltat</a> = <a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>-&gt;<a class="code" href="classModelPlane.html#ac41ad9e857dd5482e12252657ea8a4ce">input</a>[2]; <span class="comment">// Read thrust command input</span>
<a name="l00090"></a>00090         <a class="code" href="classEngBeard.html#a9a820346cfdbcfac1c4d450f850a2458">airspeed</a> = <a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>-&gt;<a class="code" href="classModelPlane.html#acc744930c5692e9e12563f9bd22f8133">airdata</a>.<a class="code" href="classAirdata.html#a5a24d6ffec10fc3b4fb03c68740054c1">airspeed</a>; <span class="comment">// Read vehicle airspeed</span>
<a name="l00091"></a>00091         <span class="comment">// Propagate rotational speed with a first order response</span>
<a name="l00092"></a>00092         <a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a> = 1 / (0.5 + <a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>-&gt;<a class="code" href="classModelPlane.html#ae079b90d2337410f9830a4593a52517c">dt</a>) * (0.5 * <a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a> + <a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>-&gt;<a class="code" href="classModelPlane.html#ae079b90d2337410f9830a4593a52517c">dt</a> * <a class="code" href="classEngBeard.html#ae2553230c21681298b084749b7c07f96">deltat</a> * <a class="code" href="classEngBeard.html#a7f4cf5ff0ed2f8720ce3fa47d3a9c9e1">k_omega</a>); <span class="comment">// Maximum omega set to 300 rad/s</span>
<a name="l00093"></a>00093         <a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>-&gt;<a class="code" href="classModelPlane.html#aedc4b75173e6c55ba63c9c972b70bb9c">states</a>.rotorspeed[0]=<a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a>; <span class="comment">// Write engine speed to states message</span>
<a name="l00094"></a>00094 }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="comment">// Calculate propulsion forces</span>
<a name="l00097"></a><a class="code" href="classEngBeard.html#ad71a8c82eae2e238346d7643b4e0112c">00097</a> geometry_msgs::Vector3 <a class="code" href="classEngBeard.html#ad71a8c82eae2e238346d7643b4e0112c">EngBeard::getForce</a>()
<a name="l00098"></a>00098 {
<a name="l00099"></a>00099         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.x = 1.0/2.0*<a class="code" href="classEngBeard.html#a5044761e486ca0717564e38166d86ebc">rho</a>*<a class="code" href="classEngBeard.html#a54fdd7e06a72fc40cd1b7736e3ac3f91">s_prop</a>*<a class="code" href="classEngBeard.html#a8ce6c3fd8c779ff7197ff0e6e8835ee7">c_prop</a>*(pow(<a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a> * <a class="code" href="classEngBeard.html#acbeca43ea5954044964b9bd1cbf6d671">k_motor</a>,2)-pow(<a class="code" href="classEngBeard.html#a9a820346cfdbcfac1c4d450f850a2458">airspeed</a>,2));
<a name="l00100"></a>00100         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.y = 0;
<a name="l00101"></a>00101         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.z = 0;
<a name="l00102"></a>00102 
<a name="l00103"></a>00103         <span class="keywordflow">return</span> <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force;
<a name="l00104"></a>00104 }
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="comment">// Calculate propulsion torques</span>
<a name="l00107"></a><a class="code" href="classEngBeard.html#a5189f5a8d67adcbfa00ced4bd6d921f9">00107</a> geometry_msgs::Vector3 <a class="code" href="classEngBeard.html#a5189f5a8d67adcbfa00ced4bd6d921f9">EngBeard::getTorque</a>()
<a name="l00108"></a>00108 {
<a name="l00109"></a>00109         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.x = -<a class="code" href="classEngBeard.html#a1fc1178d50c4f7a5184723d63edacd66">k_t_p</a>*pow(<a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a>,2);
<a name="l00110"></a>00110         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.y = 0;
<a name="l00111"></a>00111         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.z = 0;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113         <span class="comment">// Add torque to to force misalignment with CG</span>
<a name="l00114"></a>00114         <span class="comment">// r x F, where r is the distance from CoG to CoL</span>
<a name="l00115"></a>00115         <span class="comment">// Will potentially add the following code in the future, to support shift of CoG mid-flight</span>
<a name="l00116"></a>00116         <span class="comment">// XmlRpc::XmlRpcValue list;</span>
<a name="l00117"></a>00117         <span class="comment">// int i;</span>
<a name="l00118"></a>00118         <span class="comment">// if(!ros::param::getCached(&quot;motor/CGOffset&quot;, list)) {ROS_FATAL(&quot;Invalid parameters for -/motor/CGOffset- in param server!&quot;); ros::shutdown();}</span>
<a name="l00119"></a>00119         <span class="comment">// for (i = 0; i &lt; list.size(); ++i) {</span>
<a name="l00120"></a>00120         <span class="comment">//      ROS_ASSERT(list[i].getType() == XmlRpc::XmlRpcValue::TypeDouble);</span>
<a name="l00121"></a>00121         <span class="comment">//      CGOffset[i]=list[i];</span>
<a name="l00122"></a>00122         <span class="comment">// }</span>
<a name="l00123"></a>00123         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.x = <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.x + <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.y*<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.z - <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.z*<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.y;
<a name="l00124"></a>00124         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.y = <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.y - <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.x*<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.z + <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.z*<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.x;
<a name="l00125"></a>00125         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.z = <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.z - <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.y*<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.x + <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.x*<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.y;
<a name="l00126"></a>00126 
<a name="l00127"></a>00127         <span class="keywordflow">return</span> <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque;
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00131"></a>00131 <span class="comment">// Piston engine model (based upon Zanzoterra 305i)</span>
<a name="l00133"></a>00133 <span class="comment"></span>
<a name="l00134"></a>00134 <span class="comment">// Constructor</span>
<a name="l00135"></a><a class="code" href="classPistonEng.html#af3ea1af905f34a71c8b824b121dbdaeb">00135</a> <a class="code" href="classPistonEng.html#af3ea1af905f34a71c8b824b121dbdaeb">PistonEng::PistonEng</a>(<a class="code" href="classModelPlane.html">ModelPlane</a> * parent) : <a class="code" href="classPropulsion.html">Propulsion</a>(parent)
<a name="l00136"></a>00136 {
<a name="l00137"></a>00137         XmlRpc::XmlRpcValue list;
<a name="l00138"></a>00138         <span class="keywordtype">int</span> i, length;
<a name="l00139"></a>00139         <span class="keywordtype">char</span> <a class="code" href="namespacec__drag__a__server.html#a8bff9377d4de74f71009f47208b44f0b">s</a>[100];
<a name="l00140"></a>00140         <span class="keywordflow">if</span>(!ros::param::getCached(<span class="stringliteral">&quot;motor/propDiam&quot;</span>, <a class="code" href="classPistonEng.html#abc8050756131e8fc709d6602e09d4ce0">propDiam</a>)) {ROS_FATAL(<span class="stringliteral">&quot;Invalid parameters for -propDiam- in param server!&quot;</span>); ros::shutdown();}
<a name="l00141"></a>00141         <span class="keywordflow">if</span>(!ros::param::getCached(<span class="stringliteral">&quot;motor/engInertia&quot;</span>, <a class="code" href="classPistonEng.html#a0c7248b4b32bad3e75cb5c19c42af543">engInertia</a>)) {ROS_FATAL(<span class="stringliteral">&quot;Invalid parameters for -engInertia- in param server!&quot;</span>); ros::shutdown();}
<a name="l00142"></a>00142         <span class="comment">// Initialize RadPS limits</span>
<a name="l00143"></a>00143         <span class="keywordflow">if</span>(!ros::param::getCached(<span class="stringliteral">&quot;motor/RadPSLimits&quot;</span>, list)) {ROS_FATAL(<span class="stringliteral">&quot;Invalid parameters for -RadPSLimits- in param server!&quot;</span>); ros::shutdown();}
<a name="l00144"></a>00144         ROS_ASSERT(list[0].getType() == XmlRpc::XmlRpcValue::TypeDouble);
<a name="l00145"></a>00145         <a class="code" href="classPistonEng.html#a36dc1bdd71e434b6a9ba88f0fab5b192">omegaMin</a> = list[0];
<a name="l00146"></a>00146         <a class="code" href="classPistonEng.html#af1f8ce6f40b1c5ecd92896689778ae9d">omegaMax</a> = list[1];
<a name="l00147"></a>00147 
<a name="l00148"></a>00148         <a class="code" href="classFactory.html">Factory</a> factory;
<a name="l00149"></a>00149         <span class="comment">// Create engine power polynomial</span>
<a name="l00150"></a>00150         sprintf(s,<span class="stringliteral">&quot;%s&quot;</span>,<span class="stringliteral">&quot;motor/engPowerPoly&quot;</span>);
<a name="l00151"></a>00151         <a class="code" href="classPistonEng.html#a5b80492faf5501e8ab44f648a2c65a35">engPowerPoly</a> =  factory.<a class="code" href="classFactory.html#afac44f8c128b47e742d717288e616c93">buildPolynomial</a>(s);
<a name="l00152"></a>00152         <span class="comment">// Create propeller efficiency polynomial</span>
<a name="l00153"></a>00153         sprintf(s,<span class="stringliteral">&quot;%s&quot;</span>,<span class="stringliteral">&quot;motor/nCoeffPoly&quot;</span>);
<a name="l00154"></a>00154         <a class="code" href="classPistonEng.html#abf9fa299e5a533570a9fb6c3a435c9a2">npPoly</a> =  factory.<a class="code" href="classFactory.html#afac44f8c128b47e742d717288e616c93">buildPolynomial</a>(s);
<a name="l00155"></a>00155         <span class="comment">// Create propeller power polynomial</span>
<a name="l00156"></a>00156         sprintf(s,<span class="stringliteral">&quot;%s&quot;</span>,<span class="stringliteral">&quot;motor/propPowerPoly&quot;</span>);
<a name="l00157"></a>00157         <a class="code" href="classPistonEng.html#a6c100aed8aac4b97d0623cc91b0c4830">propPowerPoly</a> =  factory.<a class="code" href="classFactory.html#afac44f8c128b47e742d717288e616c93">buildPolynomial</a>(s);
<a name="l00158"></a>00158 
<a name="l00159"></a>00159         <a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a> = <a class="code" href="classPistonEng.html#a36dc1bdd71e434b6a9ba88f0fab5b192">omegaMin</a>; <span class="comment">// Initialize engine rotational speed</span>
<a name="l00160"></a>00160 
<a name="l00161"></a>00161         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.x = 0.0;
<a name="l00162"></a>00162         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.y = 0.0;
<a name="l00163"></a>00163         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.z = 0.0;
<a name="l00164"></a>00164         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.x = 0.0;
<a name="l00165"></a>00165         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.y = 0.0;
<a name="l00166"></a>00166         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.z = 0.0;
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 <span class="comment">// Destructor</span>
<a name="l00171"></a><a class="code" href="classPistonEng.html#af2f751b5d9d64d15bb6172620cd9be07">00171</a> <a class="code" href="classPistonEng.html#af2f751b5d9d64d15bb6172620cd9be07">PistonEng::~PistonEng</a>()
<a name="l00172"></a>00172 {
<a name="l00173"></a>00173         <span class="keyword">delete</span> <a class="code" href="classPistonEng.html#abf9fa299e5a533570a9fb6c3a435c9a2">npPoly</a>;
<a name="l00174"></a>00174         <span class="comment">// delete engPowerPoly;</span>
<a name="l00175"></a>00175         <span class="keyword">delete</span> <a class="code" href="classPistonEng.html#a6c100aed8aac4b97d0623cc91b0c4830">propPowerPoly</a>;
<a name="l00176"></a>00176 }
<a name="l00177"></a>00177 
<a name="l00178"></a>00178 <span class="comment">// Update motor rotational speed and calculate thrust</span>
<a name="l00179"></a><a class="code" href="classPistonEng.html#ac284278a06067a632bdc4e9bf3ccbab9">00179</a> <span class="keywordtype">void</span> <a class="code" href="classPistonEng.html#ac284278a06067a632bdc4e9bf3ccbab9">PistonEng::updateRadPS</a>()
<a name="l00180"></a>00180 {
<a name="l00181"></a>00181         <a class="code" href="classPistonEng.html#a53292438f57bb83731a8d9a2d6556846">deltat</a> = <a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>-&gt;<a class="code" href="classModelPlane.html#ac41ad9e857dd5482e12252657ea8a4ce">input</a>[2];
<a name="l00182"></a>00182 
<a name="l00183"></a>00183         <span class="keywordtype">double</span> powerHP = <a class="code" href="classPistonEng.html#a5b80492faf5501e8ab44f648a2c65a35">engPowerPoly</a>-&gt;evaluate(<a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a>/2.0/M_PI*60);
<a name="l00184"></a>00184         <span class="keywordtype">double</span> engPower = <a class="code" href="classPistonEng.html#a53292438f57bb83731a8d9a2d6556846">deltat</a> * powerHP * 745.7; <span class="comment">// Calculate current engine power</span>
<a name="l00185"></a>00185 
<a name="l00186"></a>00186         <span class="keywordtype">double</span> advRatio = <a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>-&gt;<a class="code" href="classModelPlane.html#aedc4b75173e6c55ba63c9c972b70bb9c">states</a>.velocity.linear.x/ (<a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a>/2.0/M_PI) /<a class="code" href="classPistonEng.html#abc8050756131e8fc709d6602e09d4ce0">propDiam</a>; <span class="comment">// Convert advance ratio to dimensionless units, not 1/rad</span>
<a name="l00187"></a>00187         <span class="keywordtype">double</span> propPower = <a class="code" href="classPistonEng.html#a6c100aed8aac4b97d0623cc91b0c4830">propPowerPoly</a>-&gt;evaluate(advRatio) * <a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>-&gt;<a class="code" href="classModelPlane.html#a3659963ee4b42cf72492096e6dd02f01">environment</a>.density * pow(<a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a>/2.0/M_PI,3) * pow(<a class="code" href="classPistonEng.html#abc8050756131e8fc709d6602e09d4ce0">propDiam</a>,5);
<a name="l00188"></a>00188         <span class="keywordtype">double</span> npCoeff = <a class="code" href="classPistonEng.html#abf9fa299e5a533570a9fb6c3a435c9a2">npPoly</a>-&gt;evaluate(advRatio);
<a name="l00189"></a>00189 
<a name="l00190"></a>00190         <span class="comment">// wrenchProp.force.x = propPower*std::fabs(npCoeff)/(parentObj-&gt;states.velocity.linear.x+1.0e-10); // Added epsilon for numerical stability</span>
<a name="l00191"></a>00191         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.x = propPower*std::fabs(npCoeff/(<a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>-&gt;<a class="code" href="classModelPlane.html#aedc4b75173e6c55ba63c9c972b70bb9c">states</a>.velocity.linear.x+1.0e-10)); <span class="comment">// Added epsilon for numerical stability</span>
<a name="l00192"></a>00192 
<a name="l00193"></a>00193         <span class="comment">// Constrain propeller force to +-2 times the aircraft weight</span>
<a name="l00194"></a>00194         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.x = std::max(std::min(<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.x, 2.0*<a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>-&gt;<a class="code" href="classModelPlane.html#ac3c206c8d80815650b1c5212702503cd">kinematics</a>.<a class="code" href="classKinematics.html#aafa646a6baf3a787a98a549cdf1f0786">mass</a>*9.81), -2.0*<a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>-&gt;<a class="code" href="classModelPlane.html#ac3c206c8d80815650b1c5212702503cd">kinematics</a>.<a class="code" href="classKinematics.html#aafa646a6baf3a787a98a549cdf1f0786">mass</a>*9.81);
<a name="l00195"></a>00195         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.x = propPower / <a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a>;
<a name="l00196"></a>00196         <span class="keywordflow">if</span> (<a class="code" href="classPistonEng.html#a53292438f57bb83731a8d9a2d6556846">deltat</a> &lt; 0.01) {
<a name="l00197"></a>00197                 <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.x = 0;
<a name="l00198"></a>00198                 <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.x = 0;
<a name="l00199"></a>00199         } <span class="comment">// To avoid aircraft rolling while on the ground, since we don&#39;t have static friction yet</span>
<a name="l00200"></a>00200         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.y = 0.0;
<a name="l00201"></a>00201         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.z = 0.0;
<a name="l00202"></a>00202         <span class="comment">// double deltaP = parentObj-&gt;kinematics.forceInput.x * parentObj-&gt;states.velocity.linear.x / npCoeff;</span>
<a name="l00203"></a>00203         <span class="keywordtype">double</span> deltaT = (engPower - propPower)/<a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a>;
<a name="l00204"></a>00204         <span class="keywordtype">double</span> omegaDot = 1/<a class="code" href="classPistonEng.html#a0c7248b4b32bad3e75cb5c19c42af543">engInertia</a>*deltaT;
<a name="l00205"></a>00205         <a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a> += omegaDot*<a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>-&gt;<a class="code" href="classModelPlane.html#ae079b90d2337410f9830a4593a52517c">dt</a>;
<a name="l00206"></a>00206         <a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a> = std::max(std::min(<a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a>, <a class="code" href="classPistonEng.html#af1f8ce6f40b1c5ecd92896689778ae9d">omegaMax</a>), <a class="code" href="classPistonEng.html#a36dc1bdd71e434b6a9ba88f0fab5b192">omegaMin</a>); <span class="comment">// Constrain omega to working range</span>
<a name="l00207"></a>00207 
<a name="l00208"></a>00208         <a class="code" href="classPropulsion.html#a32f614234c4c5ba948ff060598ac8da9">parentObj</a>-&gt;<a class="code" href="classModelPlane.html#aedc4b75173e6c55ba63c9c972b70bb9c">states</a>.rotorspeed[0]=<a class="code" href="classPropulsion.html#a2c304538148a4187a25fe24bfa5c15f5">omega</a>; <span class="comment">// Write engine speed to states message</span>
<a name="l00209"></a>00209 
<a name="l00210"></a>00210         <span class="comment">// Printouts</span>
<a name="l00211"></a>00211         <span class="comment">// std::cout &lt;&lt; deltat &lt;&lt; &quot; &quot;;</span>
<a name="l00212"></a>00212         <span class="comment">// std::cout &lt;&lt; powerHP &lt;&lt; &quot; &quot;;</span>
<a name="l00213"></a>00213         <span class="comment">// std::cout &lt;&lt; engPower &lt;&lt; &quot; &quot;;</span>
<a name="l00214"></a>00214         <span class="comment">// std::cout &lt;&lt; propPower &lt;&lt; &quot; &quot;;</span>
<a name="l00215"></a>00215         <span class="comment">// std:: cout &lt;&lt; advRatio &lt;&lt; &quot; &quot;;</span>
<a name="l00216"></a>00216         <span class="comment">// std::cout &lt;&lt; npCoeff &lt;&lt; &quot; &quot;;</span>
<a name="l00217"></a>00217         <span class="comment">// std::cout &lt;&lt; wrenchProp.force.x &lt;&lt; &quot; &quot;;</span>
<a name="l00218"></a>00218         <span class="comment">// std::cout &lt;&lt; wrenchProp.torque.x &lt;&lt; &quot; &quot;;</span>
<a name="l00219"></a>00219         <span class="comment">// std::cout &lt;&lt; parentObj-&gt;kinematics.forceInput.x &lt;&lt; &quot; &quot;;</span>
<a name="l00220"></a>00220         <span class="comment">// std::cout &lt;&lt; omegaDot &lt;&lt; &quot; &quot;;</span>
<a name="l00221"></a>00221         <span class="comment">// std::cout &lt;&lt; omega;</span>
<a name="l00222"></a>00222         <span class="comment">// std::cout &lt;&lt; std::endl;</span>
<a name="l00223"></a>00223 
<a name="l00224"></a>00224 }
<a name="l00225"></a>00225 
<a name="l00226"></a><a class="code" href="classPistonEng.html#a1c18c6a4b9c3e834b6e509ed01fb1107">00226</a> geometry_msgs::Vector3 <a class="code" href="classPistonEng.html#a1c18c6a4b9c3e834b6e509ed01fb1107">PistonEng::getForce</a>()
<a name="l00227"></a>00227 {
<a name="l00228"></a>00228         <span class="keywordflow">if</span> (isnan(<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.x) || isnan(<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.y) || isnan(<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.z)) {
<a name="l00229"></a>00229                 ROS_FATAL(<span class="stringliteral">&quot;State NaN in wrenchProp.force&quot;</span>);
<a name="l00230"></a>00230                 ros::shutdown();
<a name="l00231"></a>00231         }
<a name="l00232"></a>00232         <span class="keywordflow">return</span> <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force;
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 
<a name="l00235"></a><a class="code" href="classPistonEng.html#a69aa6fb0878bb65102eb20cfcbbfc0c3">00235</a> geometry_msgs::Vector3 <a class="code" href="classPistonEng.html#a69aa6fb0878bb65102eb20cfcbbfc0c3">PistonEng::getTorque</a>()
<a name="l00236"></a>00236 {
<a name="l00237"></a>00237         <span class="keywordflow">if</span> (isnan(<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.x) || isnan(<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.y) || isnan(<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.z)) {
<a name="l00238"></a>00238                 ROS_FATAL(<span class="stringliteral">&quot;State NaN in wrenchProp.torque&quot;</span>);
<a name="l00239"></a>00239                 ros::shutdown();
<a name="l00240"></a>00240         }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242         <span class="comment">// Add torque to to force misalignment with CG</span>
<a name="l00243"></a>00243         <span class="comment">// r x F, where r is the distance from CoG to CoL</span>
<a name="l00244"></a>00244         <span class="comment">// Will potentially add the following code in the future, to support shift of CoG mid-flight</span>
<a name="l00245"></a>00245         <span class="comment">// XmlRpc::XmlRpcValue list;</span>
<a name="l00246"></a>00246         <span class="comment">// int i;</span>
<a name="l00247"></a>00247         <span class="comment">// if(!ros::param::getCached(&quot;motor/CGOffset&quot;, list)) {ROS_FATAL(&quot;Invalid parameters for -/motor/CGOffset- in param server!&quot;); ros::shutdown();}</span>
<a name="l00248"></a>00248         <span class="comment">// for (i = 0; i &lt; list.size(); ++i) {</span>
<a name="l00249"></a>00249         <span class="comment">//      ROS_ASSERT(list[i].getType() == XmlRpc::XmlRpcValue::TypeDouble);</span>
<a name="l00250"></a>00250         <span class="comment">//      CGOffset[i]=list[i];</span>
<a name="l00251"></a>00251         <span class="comment">// }</span>
<a name="l00252"></a>00252         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.x = <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.x + <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.y*<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.z - <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.z*<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.y;
<a name="l00253"></a>00253         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.y = <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.y - <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.x*<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.z + <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.z*<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.x;
<a name="l00254"></a>00254         <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.z = <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque.z - <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.y*<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.x + <a class="code" href="classPropulsion.html#a49c64410d2bb337952807e99561513ae">CGOffset</a>.x*<a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.force.y;
<a name="l00255"></a>00255 
<a name="l00256"></a>00256         <span class="keywordflow">return</span> <a class="code" href="classPropulsion.html#add435dbb9bc67158452d1c181a162bcc">wrenchProp</a>.torque;
<a name="l00257"></a>00257 }
</pre></div></div><!-- contents -->

<br clear="all" />
<hr size="1"><div style="align: right;">
<a href="http://wiki.ros.org/last_letter">last_letter</a><br />
Author(s): George Zogopoulos Papaliakos <gzogop@mail.ntua.gr>, Panos Marantos</br />
<small>autogenerated on Mon Feb 23 2015 00:50:17</small>
</div>
</body>
</html>
